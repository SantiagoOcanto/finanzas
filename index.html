<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balance Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --soft-pink: #fff0f3; --main-pink: #fce4ec; --accent-pink: #f06292; --text-color: #5d1029; }
        body { background-color: var(--soft-pink); color: var(--text-color); font-family: sans-serif; padding: 15px; }
        
        .card-custom { background: white; border-radius: 25px; padding: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); margin-bottom: 15px; }
        
        /* Saldo Centralizado */
        .saldo-display { font-size: 2.8rem; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .btn-eye { border: none; background: var(--main-pink); color: var(--accent-pink); padding: 5px 15px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }

        /* Stats Mensuales */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: var(--soft-pink); padding: 10px; border-radius: 15px; text-align: center; }
        .stat-label { font-size: 0.6rem; text-transform: uppercase; font-weight: bold; color: var(--accent-pink); }
        .stat-val { font-size: 0.9rem; font-weight: 700; }

        .form-control, .form-select { border-radius: 12px !important; border: 1px solid var(--main-pink) !important; margin-bottom: 8px; font-size: 0.9rem; }
        .btn-reg { background: var(--accent-pink); color: white; border: none; border-radius: 12px; width: 100%; padding: 12px; font-weight: bold; }
        
        .movimiento-linea { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--soft-pink); font-size: 0.85rem; }
        .v-pos { color: #2fb380; font-weight: bold; }
        .v-neg { color: #e55039; font-weight: bold; }
        .mini-tag { font-size: 0.65rem; background: var(--main-pink); padding: 2px 6px; border-radius: 5px; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="card-custom">
        <div class="saldo-display">
            <span id="saldoTexto">••••••</span>
            <button class="btn-eye" onclick="toggleOjo()">VER</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-label">Ingresos Mes</div>
                <div class="stat-val v-pos" id="statIngresos">0,00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Gastos Mes</div>
                <div class="stat-val v-neg" id="statGastos">0,00</div>
            </div>
        </div>
    </div>

    <div class="card-custom">
        <form id="formMov">
            <input type="hidden" name="action" value="add">
            
            <select name="hoja" id="selectorHoja" class="form-select" onchange="actualizarCategorias()">
                <option value="Personal">Personal</option>
                <option value="Trabajos">Trabajo</option>
                <option value="Eventos">Eventos</option>
            </select>

            <input type="text" name="concepto" class="form-control" placeholder="Concepto" required>
            
            <div class="row g-2">
                <div class="col-6">
                    <input type="text" name="monto" class="form-control" placeholder="Monto 0,00" required>
                </div>
                <div class="col-6">
                    <select name="tipo" class="form-select">
                        <option value="Egreso">Salida (-)</option>
                        <option value="Ingreso">Entrada (+)</option>
                    </select>
                </div>
            </div>

            <div class="row g-2">
                <div class="col-6">
                    <select name="categoria" id="selectorCat" class="form-select" onchange="checkPañol()">
                        </select>
                </div>
                <div class="col-6">
                    <select name="metodo" class="form-select">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Digital">Plataforma Digital</option>
                    </select>
                </div>
            </div>

            <div id="divTurnos" style="display:none;">
                <input type="number" name="turnos" class="form-control" placeholder="Cantidad de turnos">
            </div>

            <button type="submit" class="btn-reg" id="btnMain">REGISTRAR</button>
        </form>
    </div>

    <div class="accordion" id="accMain">
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwZi85N-iFxBXTk3Ial_2QHAmVq_Nm3i5Y4DZmQqAoU-n7B2WmxVXGn_hr7tkp3IABi/exec';
        let valorReal = 0;
        let esVisible = false;

        const cats = {
            "Personal": ["Compras", "Servicios", "Otros"],
            "Trabajos": ["Materiales", "Mano de Obra", "Viáticos", "Cobros"],
            "Eventos": ["Alquileres", "Foodtrucks", "Pañol", "Otros servicios"]
        };

        function actualizarCategorias() {
            const hoja = document.getElementById('selectorHoja').value;
            const sel = document.getElementById('selectorCat');
            sel.innerHTML = cats[hoja].map(c => `<option value="${c}">${c}</option>`).join('');
            checkPañol();
        }

        function checkPañol() {
            const cat = document.getElementById('selectorCat').value;
            document.getElementById('divTurnos').style.display = (cat === "Pañol") ? "block" : "none";
        }

        const fmt = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2 });

        function toggleOjo() {
            esVisible = !esVisible;
            document.getElementById('saldoTexto').innerText = esVisible ? fmt.format(valorReal) : "••••••";
        }

        async function cargar() {
            try {
                const r = await fetch(`${scriptURL}?t=${Date.now()}`);
                const d = await r.json();
                let total = 0, mesI = 0, mesG = 0;
                const hoy = new Date();
                
                const acc = document.getElementById('accMain');
                acc.innerHTML = "";

                Object.keys(d).forEach(h => {
                    let itemsHtml = "";
                    d[h].reverse().forEach(f => {
                        const i = parseFloat(f[2]) || 0;
                        const e = parseFloat(f[3]) || 0;
                        total += (i - e);

                        // Stats mensuales
                        const fechaFila = new Date(f[0]);
                        if(fechaFila.getMonth() === hoy.getMonth() && fechaFila.getFullYear() === hoy.getFullYear()){
                            mesI += i; mesG += e;
                        }

                        itemsHtml += `<div class="movimiento-linea">
                            <span>${f[1]} <br><small style="color:#bfa5ae">${f[4]} | ${f[5]}</small></span>
                            <span class="${i>0?'v-pos':'v-neg'}">${fmt.format(i||e)}</span>
                        </div>`;
                    });

                    acc.innerHTML += `
                        <div class="accordion-item" style="border:none; background:none;">
                            <button class="accordion-button collapsed card-custom mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#c${h}">
                                ${h}
                            </button>
                            <div id="c${h}" class="accordion-collapse collapse" data-bs-parent="#accMain">
                                <div class="card-custom mb-3">${itemsHtml || 'Sin datos'}</div>
                            </div>
                        </div>`;
                });

                valorReal = total;
                document.getElementById('statIngresos').innerText = fmt.format(mesI);
                document.getElementById('statGastos').innerText = fmt.format(mesG);
                if(esVisible) toggleOjo();
            } catch (e) { console.error(e); }
        }

        document.getElementById('formMov').onsubmit = async (e) => {
            e.preventDefault();
            const b = document.getElementById('btnMain');
            b.disabled = true; b.innerText = "ESPERE...";
            await fetch(scriptURL, { method: 'POST', body: new FormData(e.target) });
            e.target.reset();
            actualizarCategorias();
            cargar();
            b.disabled = false; b.innerText = "REGISTRAR";
        };

        window.onload = () => { actualizarCategorias(); cargar(); };
    </script>
</body>
</html>
