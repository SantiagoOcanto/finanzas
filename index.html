<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Balance</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --soft-pink: #fff0f3;
            --main-pink: #fce4ec;
            --accent-pink: #f06292;
            --text-color: #5d1029;
            --white: #ffffff;
        }

        body { 
            background-color: var(--soft-pink); 
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Tarjeta de Saldo */
        .card-balance {
            background: var(--white);
            border-radius: 30px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(240, 98, 146, 0.12);
        }

        .label-total {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--accent-pink);
            margin-bottom: 5px;
        }

        .saldo-display {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            min-height: 4rem;
        }

        .btn-eye {
            border: none;
            background: var(--main-pink);
            color: var(--accent-pink);
            font-size: 0.65rem;
            font-weight: 800;
            padding: 8px 12px;
            border-radius: 15px;
            text-transform: uppercase;
        }

        /* Formulario Compacto */
        .card-form {
            background: var(--white);
            border-radius: 25px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
        }

        .form-control, .form-select {
            background-color: var(--soft-pink) !important;
            border: none !important;
            border-radius: 15px !important;
            padding: 12px 15px !important;
            color: var(--text-color) !important;
            font-size: 0.95rem !important;
            margin-bottom: 10px;
        }

        .btn-register {
            background-color: var(--accent-pink);
            color: var(--white);
            border: none;
            border-radius: 15px;
            padding: 14px;
            width: 100%;
            font-weight: 700;
            font-size: 1rem;
            box-shadow: 0 5px 15px rgba(240, 98, 146, 0.3);
            margin-top: 5px;
        }

        /* Acordeones Estilo iOS */
        .accordion-item {
            border: none !important;
            background: transparent !important;
            margin-bottom: 12px;
        }

        .accordion-button {
            background: var(--white) !important;
            border-radius: 20px !important;
            color: var(--text-color) !important;
            font-weight: 700 !important;
            font-size: 0.9rem;
            padding: 18px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03) !important;
        }

        .accordion-button:not(.collapsed) {
            color: var(--accent-pink) !important;
            box-shadow: 0 4px 12px rgba(240, 98, 146, 0.1) !important;
        }

        .accordion-button::after {
            filter: sepia(100%) saturate(200%) hue-rotate(300deg);
        }

        .movimiento-linea {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 5px;
            border-bottom: 1px solid var(--soft-pink);
            font-size: 0.9rem;
        }

        .valor-ingreso { color: #2fb380; font-weight: 700; }
        .valor-egreso { color: #e55039; font-weight: 700; }

        .sync-text {
            font-size: 0.65rem;
            color: #bfa5ae;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="card-balance">
        <div class="label-total">Dinero Disponible</div>
        <div class="saldo-display">
            <span id="saldoTexto">••••••</span>
            <button class="btn-eye" onclick="toggleOjo()" id="btnEye">Ver</button>
        </div>
        <div class="sync-text" id="status">Sincronizando...</div>
    </div>

    <div class="card-form">
        <form id="formMovimiento">
            <input type="hidden" name="action" value="add">
            <input type="text" name="concepto" class="form-control" placeholder="Nombre del movimiento" required>
            
            <div class="row g-2">
                <div class="col-7">
                    <input type="text" name="monto" class="form-control" placeholder="Monto 0,00" required>
                </div>
                <div class="col-5">
                    <select name="tipo" class="form-select">
                        <option value="Ingreso">Entrada</option>
                        <option value="Egreso">Salida</option>
                    </select>
                </div>
            </div>

            <select name="hoja" class="form-select">
                <option value="Personal">Cuenta Personal</option>
                <option value="Trabajos">Cuenta Trabajo</option>
            </select>

            <button type="submit" class="btn-register" id="btnMain">Registrar</button>
        </form>
    </div>

    <div class="accordion" id="parentAcc">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accPers">
                    Personal
                </button>
            </h2>
            <div id="accPers" class="accordion-collapse collapse" data-bs-parent="#parentAcc">
                <div class="accordion-body" id="listPers"></div>
            </div>
        </div>

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accTrab">
                    Trabajo
                </button>
            </h2>
            <div id="accTrab" class="accordion-collapse collapse" data-bs-parent="#parentAcc">
                <div class="accordion-body" id="listTrab"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwZi85N-iFxBXTk3Ial_2QHAmVq_Nm3i5Y4DZmQqAoU-n7B2WmxVXGn_hr7tkp3IABi/exec'; // <--- PEGA TU URL DE GOOGLE AQUÍ
        let valorReal = 0;
        let esVisible = false;

        const formatMoney = new Intl.NumberFormat('es-AR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });

        function toggleOjo() {
            esVisible = !esVisible;
            const txt = document.getElementById('saldoTexto');
            const btn = document.getElementById('btnEye');
            txt.innerText = esVisible ? formatMoney.format(valorReal) : "••••••";
            btn.innerText = esVisible ? "Ocultar" : "Ver";
        }

        async function fetchInfo() {
            document.getElementById('status').innerText = "Cargando...";
            try {
                const r = await fetch(`${scriptURL}?t=${Date.now()}`, { cache: 'no-store' });
                const d = await r.json();
                
                let acum = 0;
                
                ["Personal", "Trabajos"].forEach(h => {
                    const container = document.getElementById(h === "Personal" ? 'listPers' : 'listTrab');
                    container.innerHTML = "";
                    const items = d[h] || [];
                    
                    items.reverse().forEach(f => {
                        const i = parseFloat(f[2]) || 0;
                        const e = parseFloat(f[3]) || 0;
                        acum += (i - e);

                        const htmlMonto = i > 0 ? 
                            `<span class="valor-ingreso">${formatMoney.format(i)}</span>` : 
                            `<span class="valor-egreso">-${formatMoney.format(e)}</span>`;

                        container.innerHTML += `
                            <div class="movimiento-linea">
                                <span>${f[1]}</span>
                                <span>${htmlMonto}</span>
                            </div>`;
                    });
                });

                valorReal = acum;
                if(esVisible) document.getElementById('saldoTexto').innerText = formatMoney.format(valorReal);
                document.getElementById('status').innerText = "Última sincro: " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            } catch (err) {
                document.getElementById('status').innerText = "Sin conexión";
            }
        }

        document.getElementById('formMovimiento').onsubmit = async (e) => {
            e.preventDefault();
            const b = document.getElementById('btnMain');
            b.disabled = true;
            b.innerText = "Registrando...";
            
            try {
                await fetch(scriptURL, { method: 'POST', body: new FormData(e.target) });
                e.target.reset();
                setTimeout(fetchInfo, 1200);
            } catch (x) {
                alert("Error de red");
            } finally {
                b.disabled = false;
                b.innerText = "Registrar";
            }
        };

        window.onload = fetchInfo;
    </script>
</body>
</html>